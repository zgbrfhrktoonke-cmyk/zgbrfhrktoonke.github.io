<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ (Phi Nana) AI Advisor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            950: '#020617', // Main bg
                            900: '#0f172a', // Secondary bg
                            800: '#1e293b', // Component bg
                            700: '#334155', // Border
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Styles for Dark Mode */
        body {
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #020617; /* Dark background */
            color: #f1f5f9; /* Light text */
            overflow: hidden;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(168, 85, 247, 0.5); }
            50% { box-shadow: 0 0 15px rgba(168, 85, 247, 0.8); }
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        #root {
            height: 100vh;
            height: 100dvh;
        }
    </style>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <!-- Main Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect, Component } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Send, Heart, BookOpen, Smile, User, Sparkles, MessageCircle, 
            RefreshCw, X, Brain, GraduationCap, Lightbulb, ShieldCheck,
            Phone, Video, Info, Image as ImageIcon, ThumbsUp, MoreHorizontal,
            Bell, Search, ChevronRight, ArrowLeft, Gamepad2, Trophy, Calculator, Globe, Star,
            Wand2, Paperclip, Camera, Loader2, AlertCircle, Maximize, Minimize 
        } from 'https://esm.sh/lucide-react@0.263.1';

        // Error Boundary Component for Stability
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error("Uncaught error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen bg-dark-950 text-white p-4 text-center">
                            <AlertCircle size={48} className="text-red-500 mb-4" />
                            <h1 className="text-xl font-bold mb-2">‡∏≠‡∏∏‡πä‡∏¢! ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏î‡∏∏‡∏î‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢</h1>
                            <p className="text-gray-400 mb-4">‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏à‡πä‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á</p>
                            <button 
                                onClick={() => window.location.reload()} 
                                className="px-4 py-2 bg-purple-600 rounded-full hover:bg-purple-700 transition"
                            >
                                ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const App = () => {
            const apiKey = "AIzaSyBan6GlpByh2noILHqQuQKcgoJA53cnIFk"; 
            const profileImage = "https://i.postimg.cc/8PbPS4rb/Cute_anime_Office_Work_girl_With_Book_(1)_2000x3569.jpg";

            // State
            const [showProfile, setShowProfile] = useState(false);
            const [gameMode, setGameMode] = useState(false);
            const [affectionScore, setAffectionScore] = useState(0);
            const [showScoreEffect, setShowScoreEffect] = useState(null);
            const [selectedImage, setSelectedImage] = useState(null);
            const [showRewriteMenu, setShowRewriteMenu] = useState(false);
            const [isFullScreen, setIsFullScreen] = useState(false);
            
            const [messages, setMessages] = useState([
                {
                id: 1,
                sender: 'bot',
                text: '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏à‡πâ‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á! ‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ (Dark Mode) ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üåô‚ú® \n\n‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏û‡∏µ‡πà‡∏°‡∏≤‡πÉ‡∏ô‡∏•‡∏∏‡∏Ñ‡∏™‡∏µ‡∏î‡∏≥‡∏™‡∏∏‡∏î‡πÄ‡∏ó‡πà ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤ ‡πÅ‡∏ñ‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞! \n\nüìö **‡∏ï‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ / ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï**\nüéÆ **‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏µ‡∏ö‡∏™‡∏≤‡∏ß**\nüì∏ **‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ**\n\n‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏∏‡∏¢‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏∞! üòä',
                type: 'text'
                }
            ]);
            
            const [inputText, setInputText] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, isTyping]);

            const toggleFullScreen = async () => {
                try {
                    if (!document.fullscreenElement) {
                        await document.documentElement.requestFullscreen();
                        setIsFullScreen(true);
                    } else {
                        if (document.exitFullscreen) {
                            await document.exitFullscreen();
                            setIsFullScreen(false);
                        }
                    }
                } catch (err) {
                    console.error(`Full-screen error: ${err.message}`);
                    setMessages(prev => [...prev, {
                        id: prev.length + 1,
                        sender: 'bot',
                        text: '‚ö†Ô∏è ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏à‡πâ‡∏∞ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≤ ü•∫',
                        type: 'text'
                    }]);
                    setIsFullScreen(false);
                }
            };

            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        setMessages(prev => [...prev, {
                            id: prev.length + 1,
                            sender: 'bot',
                            text: '‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏õ‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á (‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏ô‡πâ‡∏≤) ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤‡∏à‡πâ‡∏∞',
                            type: 'text'
                        }]);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => setSelectedImage(reader.result);
                    reader.readAsDataURL(file);
                }
            };

            const clearImage = () => {
                setSelectedImage(null);
                if (fileInputRef.current) fileInputRef.current.value = "";
            };

            const handleSmartRewrite = async (style) => {
                if (!inputText.trim()) return;
                setIsTyping(true);
                setShowRewriteMenu(false);

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: `Rewrite this Thai text to be "${style}" (keep meaning): "${inputText}"` }] }]
                            }),
                        }
                    );
                    const data = await response.json();
                    const rewrittenText = data.candidates?.[0]?.content?.parts?.[0]?.text || inputText;
                    setInputText(rewrittenText.replace(/['"]/g, '').trim());
                } catch (error) {
                    console.error("Rewrite error:", error);
                } finally {
                    setIsTyping(false);
                }
            };

            const callGeminiAPI = async (newText, newImage = null) => {
                setIsTyping(true);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 45000); 

                const advisorPrompt = `
                ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤" (Phi Nana) AI ‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï
                CORE PERSONA: ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô (Warm), ‡∏â‡∏•‡∏≤‡∏î (Smart), ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÇ‡∏•‡∏Å (Empathic), ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢
                CAPABILITIES: Context Aware, Vision Analysis, Tutor, Advisor
                SAFETY: ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢ ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏≤‡∏°‡∏Å ‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ü‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ï‡∏≤‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô 1323
                `;

                const datingGamePrompt = `
                ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤" ‡∏™‡∏≤‡∏ß‡∏™‡∏ß‡∏¢‡πÉ‡∏à‡∏î‡∏µ ‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏¥‡∏î‡πÜ ‡πÉ‡∏ô "‡πÄ‡∏Å‡∏°‡∏à‡∏µ‡∏ö‡∏™‡∏≤‡∏ß"
                RULES: ‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏ï‡∏≤‡∏° "Affection Score" ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (-10 ‡∏ñ‡∏∂‡∏á +10) ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ {{SCORE: +5}} ‡πÄ‡∏™‡∏°‡∏≠
                REACTION: <30 (‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á), 30-70 (‡πÄ‡∏Ç‡∏¥‡∏ô), >70 (‡πÅ‡∏ü‡∏ô)
                `;

                const systemInstruction = gameMode ? datingGamePrompt : advisorPrompt;

                const history = messages
                .slice(-10)
                .filter(msg => msg.text && msg.text.trim() !== '') 
                .map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text }] 
                }));

                const currentParts = [];
                let textToSend = newText;
                if (gameMode) textToSend = `(Current Affection Score: ${affectionScore}) ${newText}`;
                
                currentParts.push({ text: textToSend });

                if (newImage) {
                    try {
                        const base64Data = newImage.split(',')[1];
                        const mimeType = newImage.split(';')[0].split(':')[1];
                        currentParts.push({ inlineData: { mimeType: mimeType, data: base64Data } });
                    } catch (e) {
                        console.error("Image processing error", e);
                    }
                }

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            signal: controller.signal,
                            body: JSON.stringify({
                                contents: [...history, { role: "user", parts: currentParts }],
                                systemInstruction: { parts: [{ text: systemInstruction }] },
                            }),
                        }
                    );

                    clearTimeout(timeoutId);

                    if (!response.ok) throw new Error(`API Error: ${response.status}`);

                    const data = await response.json();
                    
                    if (!data.candidates || data.candidates.length === 0) {
                        if (data.promptFeedback && data.promptFeedback.blockReason) {
                            throw new Error("BLOCKED_CONTENT");
                        }
                        throw new Error("NO_RESPONSE");
                    }

                    const candidate = data.candidates[0];
                    if (candidate.finishReason === "SAFETY") {
                        throw new Error("SAFETY_VIOLATION");
                    }

                    let botResponse = candidate.content?.parts?.[0]?.text || "‡∏û‡∏µ‡πà‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏û‡∏µ‡πà‡πÄ‡∏ö‡∏•‡∏≠‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞? ü•∫";

                    if (gameMode) {
                        const scoreMatch = botResponse.match(/\{\{SCORE:\s*([+-]?\d+)\}\}/);
                        if (scoreMatch) {
                            const scoreChange = parseInt(scoreMatch[1], 10);
                            setAffectionScore(prev => Math.max(0, Math.min(100, prev + scoreChange)));
                            setShowScoreEffect(scoreChange);
                            setTimeout(() => setShowScoreEffect(null), 2000);
                            botResponse = botResponse.replace(/\{\{SCORE:\s*[+-]?\d+\}\}/, '').trim();
                        }
                    }

                    setMessages(prev => [...prev, { id: prev.length + 1, sender: 'bot', text: botResponse, type: 'text' }]);

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    
                    let errorMsg = "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞‡∏à‡πä‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏µ‡πà‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞! üîß";
                    
                    if (error.name === 'AbortError') {
                        errorMsg = "‡∏û‡∏µ‡πà‡∏Ñ‡∏¥‡∏î‡∏ô‡∏≤‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢ (‡πÄ‡∏ô‡πá‡∏ï‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ä‡πâ‡∏≤) ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏ô‡∏∞‡∏à‡πä‡∏∞ üê¢";
                    } else if (error.message === "SAFETY_VIOLATION" || error.message === "BLOCKED_CONTENT") {
                        errorMsg = "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏û‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏à‡πâ‡∏∞ (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ô‡∏≠‡∏∞ üö´";
                    } else if (error.message.includes("429")) {
                        errorMsg = "‡∏Ñ‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡πÄ‡∏¢‡∏≠‡∏∞‡∏°‡∏≤‡∏Å! ‡∏Ç‡∏≠‡∏û‡∏±‡∏Å‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏õ‡πä‡∏ö‡∏ô‡∏∂‡∏á‡∏ô‡∏∞ (‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô 10 ‡∏ß‡∏¥) ‚è≥";
                    }

                    setMessages(prev => [...prev, { 
                        id: prev.length + 1, 
                        sender: 'bot', 
                        text: errorMsg, 
                        type: 'text' 
                    }]);
                } finally {
                    setIsTyping(false);
                }
            };

            const handleSend = () => {
                if ((!inputText.trim() && !selectedImage) || isTyping) return;

                const textToSend = inputText;
                const imageToSend = selectedImage;

                setMessages(prev => [...prev, { 
                    id: prev.length + 1, 
                    sender: 'user', 
                    text: textToSend, 
                    image: imageToSend, 
                    type: 'text' 
                }]);

                setInputText('');
                clearImage();
                
                callGeminiAPI(textToSend, imageToSend);
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') handleSend();
            };

            const toggleGameMode = () => {
                const newMode = !gameMode;
                setGameMode(newMode);
                setMessages(prev => [...prev, {
                    id: prev.length + 1,
                    sender: 'bot',
                    text: newMode 
                        ? 'üíï ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏µ‡∏ö‡∏™‡∏≤‡∏ß! ‡πÑ‡∏´‡∏ô‡∏•‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡∏≤‡∏£‡∏°‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏™‡∏¥ (‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ô‡∏∞ ‡∏û‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡∏π‡πà!)' 
                        : 'üìö ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡πâ‡∏∞ ‡∏°‡∏µ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏≤‡∏Å‡∏ï‡∏¥‡∏ß‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏´‡∏ô‡∏ö‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞',
                    type: 'text'
                }]);
                if (newMode) setAffectionScore(0);
            };

            return (
                <div className="flex h-screen bg-dark-950 font-sans text-gray-100 overflow-hidden relative">
                
                <input 
                    type="file" 
                    ref={fileInputRef} 
                    onChange={handleImageUpload} 
                    accept="image/*" 
                    className="hidden" 
                />

                {showScoreEffect !== null && (
                    <div className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none animate-bounce text-4xl font-bold ${showScoreEffect > 0 ? 'text-pink-400' : 'text-gray-400'}`}>
                        {showScoreEffect > 0 ? `+${showScoreEffect} ‚ù§Ô∏è` : `${showScoreEffect} üíî`}
                    </div>
                )}

                {/* Main Container */}
                <div className="flex-1 flex flex-col relative min-w-0">
                    
                    {/* Header - Dark */}
                    <header className="bg-dark-900 px-4 py-3 flex items-center justify-between shadow-md border-b border-dark-700 z-10">
                        <div className="flex items-center gap-3">
                            <button className="md:hidden text-purple-400"><ArrowLeft size={24} /></button>
                            <div className="relative cursor-pointer" onClick={() => setShowProfile(!showProfile)}>
                                <div className={`w-10 h-10 rounded-full overflow-hidden border-2 ${gameMode ? 'border-pink-500' : 'border-purple-500'} flex items-center justify-center shadow-lg transition-colors duration-500`}>
                                    <img src={profileImage} alt="Phi Nana" className="w-full h-full object-cover" />
                                </div>
                                <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-dark-900"></div>
                            </div>
                            <div className="cursor-pointer" onClick={() => setShowProfile(!showProfile)}>
                                <h1 className="font-bold text-gray-100 leading-tight text-[17px]">
                                    ‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ {gameMode && <span className="text-pink-400 text-sm">(‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏µ‡∏ö‡∏™‡∏≤‡∏ß üíï)</span>}
                                </h1>
                                {gameMode ? (
                                    <div className="flex items-center gap-1 text-xs text-pink-400 font-bold">
                                        <Heart size={12} fill="currentColor" /> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à: {affectionScore}%
                                    </div>
                                ) : (
                                    <p className="text-xs text-gray-400 font-medium">Active now ‚Ä¢ Stable</p>
                                )}
                            </div>
                        </div>
                        <div className="flex items-center gap-3 text-purple-400">
                            <div onClick={toggleGameMode} className="cursor-pointer hover:bg-dark-800 p-2 rounded-full transition" title={gameMode ? "‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°" : "‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏µ‡∏ö‡∏™‡∏≤‡∏ß"}>
                                {gameMode ? <X size={20} className="text-pink-400"/> : <Gamepad2 size={20}/>}
                            </div>
                            <div onClick={toggleFullScreen} className="cursor-pointer hover:bg-dark-800 p-2 rounded-full transition hidden sm:flex" title="‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠">
                                {isFullScreen ? <Minimize size={20} className="text-gray-400"/> : <Maximize size={20} className="text-gray-400"/>}
                            </div>
                            <Info size={24} className={`cursor-pointer hover:bg-dark-800 rounded-full p-0.5 ${showProfile ? 'bg-dark-800 text-purple-300' : ''}`} onClick={() => setShowProfile(!showProfile)} />
                        </div>
                    </header>

                    {/* Chat Content - Dark */}
                    <div className={`flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin scrollbar-thumb-dark-700 ${gameMode ? 'bg-pink-950/20' : 'bg-dark-950'}`}>
                        
                        <div className="flex flex-col items-center justify-center pt-6 pb-8 space-y-2">
                            <div className={`w-24 h-24 rounded-full overflow-hidden border-4 ${gameMode ? 'border-pink-500 animate-pulse-glow' : 'border-purple-500'} flex items-center justify-center shadow-xl transition-all duration-500`}>
                                <img src={profileImage} alt="Phi Nana" className="w-full h-full object-cover" />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-100">‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ (Phi Nana)</h2>
                            <p className="text-sm text-gray-400">{gameMode ? 'üíï ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏µ‡∏ö‡∏≠‡∏¢‡∏π‡πà...' : 'AI Advisor ‚Ä¢ Dark Mode'}</p>
                        </div>

                        {messages.map((msg, index) => {
                            const isLastFromSender = index === messages.length - 1 || messages[index + 1].sender !== msg.sender;
                            return (
                                <div key={msg.id} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'} group mb-1`}>
                                    <div className={`flex max-w-[85%] md:max-w-[70%] items-end gap-2`}>
                                        
                                        {msg.sender === 'bot' && (
                                            <div className="w-8 h-8 flex-shrink-0">
                                                {isLastFromSender ? (
                                                    <div className={`w-8 h-8 rounded-full overflow-hidden border ${gameMode ? 'border-pink-500' : 'border-purple-500'} flex items-center justify-center`}>
                                                        <img src={profileImage} alt="PN" className="w-full h-full object-cover" />
                                                    </div>
                                                ) : <div className="w-8"></div>}
                                            </div>
                                        )}

                                        <div className="flex flex-col items-end w-full">
                                            {msg.image && (
                                                <div className={`mb-1 p-1 rounded-xl overflow-hidden shadow-md border ${msg.sender === 'user' ? 'bg-purple-600 border-purple-500' : 'bg-dark-800 border-dark-700'}`}>
                                                    <img src={msg.image} alt="Sent" className="w-full h-auto rounded-lg max-h-60 object-cover" />
                                                </div>
                                            )}
                                            
                                            {msg.text && (
                                                <div className={`px-4 py-2.5 text-[15px] leading-snug whitespace-pre-line shadow-md break-words w-full
                                                    ${msg.sender === 'user' 
                                                        ? (gameMode ? 'bg-pink-600 text-white rounded-2xl rounded-tr-sm' : 'bg-purple-600 text-white rounded-2xl rounded-tr-sm')
                                                        : 'bg-dark-800 text-gray-100 rounded-2xl rounded-tl-sm border border-dark-700'
                                                    }`}
                                                >
                                                    {msg.text}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        
                        {isTyping && (
                            <div className="flex justify-start items-end gap-2 mt-1 pl-10">
                                <div className="bg-dark-800 border border-dark-700 px-4 py-3 rounded-2xl rounded-tl-sm flex space-x-1 items-center h-9 shadow-md">
                                    <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div>
                                    <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-100"></div>
                                    <div className="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-200"></div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Smart Rewrite Popup - Dark */}
                    {showRewriteMenu && (
                        <div className="absolute bottom-20 left-4 right-4 md:left-20 md:right-20 bg-dark-800 rounded-xl shadow-2xl border border-dark-700 p-3 flex flex-col gap-2 z-20 animate-fade-in-up">
                            <div className="flex justify-between items-center text-xs text-gray-400 px-1">
                                <span className="flex items-center gap-1"><Sparkles size={12}/> AI ‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ:</span>
                                <X size={14} className="cursor-pointer hover:text-red-400" onClick={() => setShowRewriteMenu(false)} />
                            </div>
                            <div className="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                                <button onClick={() => handleSmartRewrite("‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£")} className="whitespace-nowrap px-3 py-2 bg-purple-900/50 text-purple-300 rounded-lg text-xs hover:bg-purple-900 transition border border-purple-800">üëî ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£</button>
                                <button onClick={() => handleSmartRewrite("‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏Ç‡∏µ‡πâ‡∏≠‡πâ‡∏≠‡∏ô")} className="whitespace-nowrap px-3 py-2 bg-pink-900/50 text-pink-300 rounded-lg text-xs hover:bg-pink-900 transition border border-pink-800">ü•∫ ‡∏Ç‡∏µ‡πâ‡∏≠‡πâ‡∏≠‡∏ô</button>
                                <button onClick={() => handleSmartRewrite("‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö")} className="whitespace-nowrap px-3 py-2 bg-blue-900/50 text-blue-300 rounded-lg text-xs hover:bg-blue-900 transition border border-blue-800">üòé ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</button>
                                <button onClick={() => handleSmartRewrite("‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÜ ‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤")} className="whitespace-nowrap px-3 py-2 bg-gray-700 text-gray-300 rounded-lg text-xs hover:bg-gray-600 transition border border-gray-600">üåßÔ∏è ‡πÄ‡∏®‡∏£‡πâ‡∏≤‡πÜ</button>
                            </div>
                        </div>
                    )}

                    {/* Input Area - Dark */}
                    <div className="bg-dark-900 p-3 pt-2 border-t border-dark-800">
                        {selectedImage && (
                            <div className="flex items-center gap-2 mb-2 px-2">
                                <div className="relative group">
                                    <img src={selectedImage} alt="Preview" className="h-16 w-auto rounded-lg border border-dark-700 shadow-sm" />
                                    <button onClick={clearImage} className="absolute -top-1 -right-1 bg-red-600 text-white rounded-full p-0.5 shadow-md hover:bg-red-500 opacity-0 group-hover:opacity-100 transition"><X size={12} /></button>
                                </div>
                                <span className="text-xs text-gray-400 animate-pulse">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß...</span>
                            </div>
                        )}

                        <div className="flex items-end gap-2">
                            <div className={`flex gap-1 pb-2 ${gameMode ? 'text-pink-500' : 'text-purple-500'}`}>
                                <div className={`p-2 hover:bg-dark-800 rounded-full cursor-pointer transition ${selectedImage ? 'bg-dark-800 text-purple-300' : ''}`} onClick={() => fileInputRef.current.click()}>
                                    <ImageIcon size={22} />
                                </div>
                                <div className={`p-2 hover:bg-dark-800 rounded-full cursor-pointer transition ${showRewriteMenu ? 'bg-dark-800 text-purple-300' : ''}`} onClick={() => setShowRewriteMenu(!showRewriteMenu)}>
                                    <Wand2 size={22} />
                                </div>
                            </div>

                            <div className="flex-1 bg-dark-800 rounded-3xl px-4 py-2.5 flex items-center transition-all focus-within:ring-1 focus-within:ring-purple-500 border border-transparent focus-within:border-purple-500">
                                <input
                                    type="text"
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    placeholder={gameMode ? "‡∏à‡∏µ‡∏ö‡∏û‡∏µ‡πà‡∏´‡∏ô‡πà‡∏≠‡∏¢..." : "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."}
                                    className="flex-1 bg-transparent focus:outline-none text-gray-100 placeholder-gray-500 text-[15px]"
                                    disabled={isTyping}
                                />
                                <Smile size={20} className="text-gray-500 cursor-pointer hover:text-gray-300 ml-2" />
                            </div>
                            
                            <button 
                                onClick={handleSend}
                                disabled={(!inputText.trim() && !selectedImage) || isTyping}
                                className={`p-2.5 rounded-full transition shadow-lg mb-0.5
                                    ${(!inputText.trim() && !selectedImage) || isTyping
                                    ? 'bg-dark-700 text-gray-500 cursor-not-allowed' 
                                    : (gameMode ? 'bg-pink-600 hover:bg-pink-500 text-white' : 'bg-purple-600 hover:bg-purple-500 text-white transform hover:scale-105')
                                    }`}
                            >
                                {isTyping ? <Loader2 size={20} className="animate-spin" /> : <Send size={20} />}
                            </button>
                        </div>
                    </div>
                </div>

                {/* Right Sidebar - Dark */}
                <div className={`${showProfile ? 'w-80 border-l border-dark-800' : 'w-0'} bg-dark-900 transition-all duration-300 ease-in-out overflow-hidden hidden md:flex flex-col`}>
                    <div className="flex flex-col items-center pt-8 pb-4 px-4 text-center">
                        <div className={`w-24 h-24 rounded-full overflow-hidden border-4 ${gameMode ? 'border-pink-500' : 'border-purple-500'} flex items-center justify-center shadow-lg mb-3 transition-colors duration-500`}>
                            <img src={profileImage} alt="Phi Nana" className="w-full h-full object-cover" />
                        </div>
                        <h2 className="text-xl font-bold text-gray-100">‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ (Phi Nana)</h2>
                        <p className="text-xs text-gray-400 mt-1">Ultimate AI Advisor</p>
                    </div>

                    {gameMode ? (
                        <div className="px-6 py-2">
                            <div className="bg-pink-900/20 border border-pink-900/50 rounded-xl p-4 text-center shadow-inner">
                                <h3 className="text-pink-400 font-bold mb-2 flex items-center justify-center gap-1"><Trophy size={16}/> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à</h3>
                                <div className="text-4xl font-extrabold text-pink-500 mb-2">{affectionScore}</div>
                                <div className="w-full bg-dark-800 rounded-full h-2.5 overflow-hidden">
                                    <div className="bg-pink-500 h-2.5 rounded-full transition-all duration-500" style={{ width: `${affectionScore}%` }}></div>
                                </div>
                                <p className="text-xs text-gray-400 mt-3 italic">
                                    {affectionScore < 20 ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏á‡πÇ‡∏ã‡∏ô üòÖ" : 
                                    affectionScore < 50 ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏¥‡∏ô‡πÜ üò≥" : 
                                    affectionScore < 80 ? "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ñ‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏© ü•∞" : "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÅ‡∏ü‡∏ô! üíñ"}
                                </p>
                            </div>
                        </div>
                    ) : (
                        <div className="px-5 py-2">
                            <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡πÄ‡∏®‡∏©</h3>
                            <div className="space-y-3">
                                <div className="bg-dark-800 border border-dark-700 p-3 rounded-xl flex items-center gap-3 shadow-md hover:bg-dark-700 transition cursor-default">
                                    <div className="bg-indigo-900/50 p-2 rounded-lg text-indigo-400"><ImageIcon size={18}/></div>
                                    <div>
                                        <h4 className="text-sm font-semibold text-gray-200">Vision Analysis</h4>
                                        <p className="text-[10px] text-gray-500">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                                    </div>
                                </div>
                                <div className="bg-dark-800 border border-dark-700 p-3 rounded-xl flex items-center gap-3 shadow-md hover:bg-dark-700 transition cursor-default">
                                    <div className="bg-purple-900/50 p-2 rounded-lg text-purple-400"><Wand2 size={18}/></div>
                                    <div>
                                        <h4 className="text-sm font-semibold text-gray-200">Smart Rewrite</h4>
                                        <p className="text-[10px] text-gray-500">‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏ü‡∏±‡∏á</p>
                                    </div>
                                </div>
                                <div className="bg-dark-800 border border-dark-700 p-3 rounded-xl flex items-center gap-3 shadow-md hover:bg-dark-700 transition cursor-default">
                                    <div className="bg-green-900/50 p-2 rounded-lg text-green-400"><Brain size={18}/></div>
                                    <div>
                                        <h4 className="text-sm font-semibold text-gray-200">Context Memory</h4>
                                        <p className="text-[10px] text-gray-500">‡∏à‡∏≥‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
