<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ - ‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏ß‡∏ô‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Æ‡∏µ‡∏•‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì</title>
    <meta name="description" content="‡πÅ‡∏ä‡∏ó‡∏ö‡∏≠‡∏ó‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß‡πÅ‡∏™‡∏ô‡∏î‡∏µ Powered by Google Gemini">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Base Styles */
        body {
            font-family: 'Kanit', sans-serif;
            background: #fdfbfb;
            background-image: radial-gradient(circle at 50% 50%, #fffbf0 0%, #fff0f5 100%);
            height: 100vh;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode */
        body.dark-mode {
            background-color: #111827;
            background-image: radial-gradient(#374151 1.5px, transparent 1.5px), radial-gradient(#374151 1.5px, #111827 1.5px);
        }
        body.dark-mode header,
        body.dark-mode .game-status-bar,
        body.dark-mode .input-area {
            background: rgba(31, 41, 55, 0.98);
            border-color: #374151;
        }
        body.dark-mode h1 { color: #f472b6; }
        body.dark-mode p { color: #9ca3af; }
        body.dark-mode .bot-bubble {
            background: #1f2937;
            color: #e5e7eb;
            border-color: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body.dark-mode .user-bubble {
            background: linear-gradient(135deg, #be185d 0%, #9d174d 100%);
            color: #fce7f3;
            box-shadow: 0 2px 8px rgba(190, 24, 93, 0.4);
        }
        body.dark-mode .chip {
            background: #1f2937;
            border-color: #db2777;
            color: #f472b6;
        }
        body.dark-mode .chip:hover { background: #374151; }
        body.dark-mode input {
            background: #374151;
            color: #f3f4f6;
            border-color: #4b5563;
        }
        body.dark-mode input::placeholder { color: #9ca3af; }
        body.dark-mode .chat-avatar-small { border-color: #374151; }
        body.dark-mode #bot-avatar-container {
             border-color: #374151;
             background-color: #374151;
        }
        body.dark-mode #avatar-fallback { background-color: #1f2937; }

        /* Layout & Scroll */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch; 
        }
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background-color: rgba(255, 182, 193, 0.5); border-radius: 20px; }

        /* Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(10px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .chat-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 16px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .chat-row.bot { justify-content: flex-start; }
        .chat-row.user { justify-content: flex-end; }

        .chat-avatar-small {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
            background-color: #f0f0f0;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 22px;
            line-height: 1.6;
            font-size: 1rem;
            position: relative;
            word-wrap: break-word;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        .chat-bubble p { margin-bottom: 0.5em; }
        .chat-bubble p:last-child { margin-bottom: 0; }
        .chat-bubble ul, .chat-bubble ol { margin-left: 20px; margin-bottom: 0.5em; list-style-type: disc; }

        .bot-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }

        .user-bubble {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #5e3a3a;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(255, 154, 158, 0.3);
        }

        .game-status-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-bottom: 1px solid #ffe4e1;
            display: none;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
            color: #d81b60;
            animation: slideDown 0.4s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            z-index: 30;
        }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        .input-area {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            border-top: 1px solid rgba(255, 228, 230, 0.5);
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .typing-indicator {
            font-size: 0.85rem;
            color: #ff8da1;
            margin: 0 0 10px 58px;
            display: none;
            font-weight: 300;
            height: 20px;
        }

        .chip {
            background: white;
            border: 1px solid #ffd1dc;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #d81b60;
            white-space: nowrap;
            user-select: none;
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(255, 182, 193, 0.1);
        }
        .chip:hover {
            background: #fff0f3;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(216, 27, 96, 0.1);
        }
        
        #bot-avatar-container {
            /* Static Image - No movement animation */
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            transition: border-color 0.3s ease;
        }
        
        .avatar-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .hidden-layer { opacity: 0; pointer-events: none; z-index: -1; }
        .visible-layer { opacity: 1; z-index: 10; }
        
        /* Sad Filter Effect (Static only) */
        .anim-sad { filter: grayscale(0.6) brightness(0.9); transition: all 0.5s; }

        @media (max-width: 640px) {
            .chat-bubble { max-width: 85%; }
            .input-area { padding: 16px; padding-bottom: max(16px, env(safe-area-inset-bottom)); }
        }
    </style>
    <!-- Fallback Avatar Script -->
    <script>
        function useFallbackAvatar() {
            const img = document.getElementById('avatar-img');
            const fallback = document.getElementById('avatar-fallback');
            if(img && fallback) {
                img.style.display = 'none';
                fallback.classList.remove('hidden-layer');
                fallback.classList.add('visible-layer');
            }
        }
    </script>
</head>
<body>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md px-6 py-4 flex items-center justify-between border-b border-pink-100 sticky top-0 z-20 shadow-sm transition-colors duration-300">
        <div class="flex items-center gap-4">
            <div id="bot-avatar-container" class="w-14 h-14 md:w-16 md:h-16 bg-pink-100 rounded-full shadow-inner border-2 border-white cursor-pointer select-none relative overflow-hidden">
                <img id="avatar-img" 
                     src="https://i.postimg.cc/8PbPS4rb/Cute-anime-Office-Work-girl-With-Book-(1)-2000x3569.jpg" 
                     class="avatar-layer visible-layer w-full h-full object-cover"
                     onerror="useFallbackAvatar()"
                     alt="‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤">
                
                <div id="avatar-fallback" class="avatar-layer hidden-layer w-full h-full bg-[#f0f4f8] flex items-end justify-center overflow-hidden">
                    <svg viewBox="0 0 100 100" class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 85 Q50 95 85 85 L90 100 L10 100 Z" fill="#89C4E8" />
                        <path d="M30 75 Q50 85 70 75 L70 90 L30 90 Z" fill="#FFF0E5" />
                        <path d="M15 40 Q5 90 20 100 L80 100 Q95 90 85 40 Z" fill="#333333" />
                        <g>
                            <path d="M25 45 Q25 85 50 90 Q75 85 75 45 Q75 10 50 10 Q25 10 25 45" fill="#FFF0E5" />
                            <path d="M20 45 C20 45, 25 15, 50 20 C75 15, 80 45, 80 45 C80 45, 70 30, 60 35 C50 30, 40 35, 40 35 C30 30, 20 45, 20 45" fill="#333333" />
                            <circle cx="35" cy="53" r="6" fill="#FFF" />
                            <circle cx="65" cy="53" r="6" fill="#FFF" />
                            <circle cx="35" cy="53" r="4" fill="#4B5D7E" />
                            <circle cx="65" cy="53" r="4" fill="#4B5D7E" />
                            <path d="M46 72 Q50 74 54 72" stroke="#D81B60" stroke-width="1.5" fill="none" />
                        </g>
                    </svg>
                </div>
            </div>
            
            <div>
                <h1 class="font-bold text-pink-600 text-lg md:text-xl tracking-tight leading-tight transition-colors duration-300">‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ (AI)</h1>
                <p class="text-xs md:text-sm text-pink-400 font-light transition-colors duration-300">‡∏™‡∏≤‡∏ß‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®‡πÅ‡∏™‡∏ô‡∏î‡∏µ üìö</p>
            </div>
        </div>
        <div class="flex gap-2">
            <!-- Theme Toggle Button -->
            <button id="theme-toggle" onclick="toggleTheme()" class="bg-pink-100 text-pink-500 p-2 rounded-full hover:bg-pink-200 transition-colors shadow-sm w-10 h-10 flex items-center justify-center" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ò‡∏µ‡∏°">
                üåô
            </button>
            <button onclick="startGame()" class="bg-pink-100 text-pink-500 p-2 rounded-full hover:bg-pink-200 transition-colors shadow-sm w-10 h-10 flex items-center justify-center" title="‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏µ‡∏ö‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤">
                üéÆ
            </button>
        </div>
    </header>

    <div id="game-status" class="game-status-bar">
        <span class="font-bold">üíï ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏µ‡∏ö‡∏û‡∏µ‡πà‡∏™‡∏≤‡∏ß (Endless)</span>
        <div class="flex items-center gap-2">
            <span>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏´‡∏±‡∏ß‡πÉ‡∏à:</span>
            <div class="w-24 h-3 bg-pink-100 rounded-full overflow-hidden border border-pink-200">
                <div id="mini-heart-bar" class="h-full bg-gradient-to-r from-pink-400 to-rose-500 w-0 transition-all duration-500"></div>
            </div>
            <span id="score-display" class="text-xs text-pink-500 font-bold ml-1">0</span>
            <button onclick="quitGame()" class="text-xs text-gray-400 underline ml-2">‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡πà‡∏ô</button>
        </div>
    </div>

    <div id="chat-container" class="chat-container flex flex-col">
        <!-- Initial Message -->
    </div>

    <div id="typing" class="typing-indicator flex items-center gap-2">
        <span>‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</span>
        <span class="animate-bounce">.</span>
        <span class="animate-bounce delay-100">.</span>
        <span class="animate-bounce delay-200">.</span>
    </div>

    <div class="flex gap-2 mb-2 overflow-x-auto px-6 py-2 no-scrollbar" id="chips" style="-webkit-overflow-scrolling: touch;">
        <div class="chip border-pink-300 bg-pink-50 font-medium" onclick="startGame()">üéÆ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏à‡∏µ‡∏ö</div>
        <div class="chip" onclick="quickSend('‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏•‡∏Å‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢')">ü§£ ‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏•‡∏Å</div>
        <div class="chip" onclick="quickSend('‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏ß‡∏±‡∏ô‡∏•‡∏∞‡∏Ñ‡∏≥')">üá¨üáß ‡∏™‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏≤</div>
        <div class="chip" onclick="quickSend('‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏Ñ‡∏°‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ')">‚ú® ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏Ñ‡∏°</div>
        <div class="chip" onclick="quickSend('‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ')">üçú ‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
    </div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏à‡πâ‡∏∞..." 
               class="flex-1 p-3 md:p-4 bg-white rounded-xl border-2 border-pink-200 outline-none focus:border-pink-400 focus:ring-0 transition-all text-gray-700 placeholder-gray-400 shadow-sm">
        <button id="send-btn" class="bg-gradient-to-r from-pink-400 to-rose-400 text-white px-6 py-3 md:px-8 md:py-3 rounded-xl hover:shadow-lg hover:from-pink-500 hover:to-rose-500 active:scale-95 transition-all font-medium whitespace-nowrap shadow-md">
            ‡∏™‡πà‡∏á‡∏à‡πâ‡∏∞!
        </button>
    </div>

    <!-- API Key Warning Modal -->
    <div id="api-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-[90%] shadow-2xl text-center">
            <h3 class="text-xl font-bold text-pink-600 mb-2">‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô API Key</h3>
            <p class="text-gray-600 text-sm mb-4">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Google AI API Key ‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
            <p class="text-gray-500 text-xs mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà Key ‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà 300 ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Offline Mode (‡∏ï‡∏≠‡∏ö‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå)</p>
            <button onclick="document.getElementById('api-modal').style.display='none'" class="bg-pink-500 text-white px-6 py-2 rounded-full hover:bg-pink-600 w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
    </div>

    <!-- Module Script for Google Generative AI SDK -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // ==========================================
        // üî¥ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI (Gemini) ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üî¥
        // ==========================================
        const API_KEY = 'AIzaSyDbf5ulaU8or8KgvaKLDXlbd9V6LDXPZuw';
        // ‡πÉ‡∏ä‡πâ gemini-2.5-flash ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∏‡πà‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠
        const MODEL_NAME_PRIMARY = 'gemini-2.5-flash';
        // ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
        const MODEL_NAME_FALLBACK = 'gemini-1.5-flash'; 
        // ==========================================

        let genAI = null;
        let model = null;
        let chatSession = null;
        let isUsingFallback = false;

        // Init AI with dynamic key
        window.initAI = async function(key) {
            if (!key) return false;
            try {
                genAI = new GoogleGenerativeAI(key);
                model = genAI.getGenerativeModel({ model: MODEL_NAME_PRIMARY });
                
                const generationConfig = {
                    temperature: 0.9,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 2048,
                };
                
                const systemInstruction = "You are Pi Nana (‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤). Act as a kind, caring, slightly teasing older sister (Onee-san) who is an office worker. You are knowledgeable in Math, Science, English, and love giving advice. Speak Thai naturally, use emojis, be sweet but smart. Do not mention you are an AI unless asked specifically. Keep answers concise.";
                
                chatSession = model.startChat({
                    generationConfig,
                    history: [
                        { role: "user", parts: [{ text: systemInstruction }] },
                        { role: "model", parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏à‡πâ‡∏∞! ‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏ü‡∏±‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏à‡πä‡∏∞ üíñ" }] }
                    ],
                });
                return true;
            } catch (error) {
                console.error("AI Init Error:", error);
                return false;
            }
        };

        // Call Gemini Logic
        window.callGeminiSDK = async function(userText) {
            if (!chatSession) return null;
            try {
                const result = await chatSession.sendMessage(userText);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.warn("Primary Model Error, trying fallback...", error);
                
                if (!isUsingFallback) {
                    try {
                        isUsingFallback = true;
                        const fallbackModel = genAI.getGenerativeModel({ model: MODEL_NAME_FALLBACK });
                        // Simple retry logic without full re-init for this demo
                        return null; 
                    } catch (fallbackError) {
                        return null; 
                    }
                }
                return null;
            }
        };
        
        // Check if hardcoded key exists to skip modal
        window.getHardcodedKey = function() { return API_KEY; };
    </script>

    <!-- Main Logic Script (UI & Game) -->
    <script>
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing');
        const gameStatusBar = document.getElementById('game-status');
        const miniHeartBar = document.getElementById('mini-heart-bar');
        const scoreDisplay = document.getElementById('score-display');
        const themeToggleBtn = document.getElementById('theme-toggle');
        
        const avatarContainer = document.getElementById('bot-avatar-container');
        const avatarImg = document.getElementById('avatar-img');

        // Global State
        let gameState = { active: false, currentScenarioIndex: 0, score: parseInt(localStorage.getItem('nana_score')) || 0 };
        let isDarkMode = false;
        let userApiKey = localStorage.getItem('gemini_api_key') || '';

        window.onload = function() {
            // Check for Hardcoded Key first, then LocalStorage, then Modal
            waitForSDK().then(() => {
                const hardcodedKey = window.getHardcodedKey ? window.getHardcodedKey() : '';
                const finalKey = hardcodedKey || userApiKey;

                if (finalKey) {
                    window.initAI(finalKey);
                    addWelcomeMessage();
                } else {
                    document.getElementById('api-modal').style.display = 'flex';
                }
            });

            // Check system preference for dark mode
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                toggleTheme();
            }
        };

        // Wait for module script to load
        function waitForSDK() {
            return new Promise(resolve => {
                const check = () => {
                    if (window.initAI) resolve();
                    else setTimeout(check, 100);
                };
                check();
            });
        }

        // --- API Key Management ---
        window.saveApiKey = function() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                userApiKey = key;
                window.initAI(key);
                document.getElementById('api-modal').style.display = 'none';
                addWelcomeMessage();
            } else {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà API Key ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏à‡πä‡∏∞");
            }
        }

        window.useOfflineMode = function() {
            document.getElementById('api-modal').style.display = 'none';
            addMessage("‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏à‡πâ‡∏∞! (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå) ‡∏ñ‡∏∂‡∏á‡∏û‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏â‡∏•‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏¢‡∏ô‡∏∞! üíñ", false);
        }

        function addWelcomeMessage() {
             const hour = new Date().getHours();
            let greetingMsg = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏à‡πâ‡∏∞! ‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤ (AI) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏ñ‡∏≤‡∏°‡∏≠‡∏∞‡πÑ‡∏£‡∏¢‡∏≤‡∏Å‡πÜ ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞!";

            if (hour >= 5 && hour < 12) {
                greetingMsg = "‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå‡∏à‡πâ‡∏∞! ‡πÄ‡∏ä‡πâ‡∏≤‡∏™‡∏î‡πÉ‡∏™‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏ä‡πâ‡∏≤‡∏£‡∏∂‡∏¢‡∏±‡∏á? ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏ß‡∏á‡∏î‡∏µ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! ‚òÄÔ∏è";
            } else if (hour >= 12 && hour < 17) {
                greetingMsg = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏ï‡∏≠‡∏ô‡∏ö‡πà‡∏≤‡∏¢‡∏à‡πâ‡∏∞! ‡∏ñ‡πâ‡∏≤‡∏á‡πà‡∏ß‡∏á‡∏Å‡πá‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö‡πÅ‡∏Å‡πâ‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏û‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞ üçπ";
            } else if (hour >= 17 && hour < 22) {
                greetingMsg = "‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞! ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏±‡πâ‡∏¢? ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏Å‡∏≠‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏£‡πâ‡∏ß üåá";
            } else {
                greetingMsg = "‡∏î‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á... ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≠‡∏ô‡πÄ‡∏´‡∏£‡∏≠? ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞ üåô";
            }
            addMessage(greetingMsg, false);
            setFace('happy');
        }

        window.toggleTheme = function() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            
            if (isDarkMode) {
                themeToggleBtn.innerText = '‚òÄÔ∏è';
                themeToggleBtn.classList.replace('bg-pink-100', 'bg-gray-700');
                themeToggleBtn.classList.replace('text-pink-500', 'text-yellow-300');
                themeToggleBtn.classList.replace('hover:bg-pink-200', 'hover:bg-gray-600');
            } else {
                themeToggleBtn.innerText = 'üåô';
                themeToggleBtn.classList.replace('bg-gray-700', 'bg-pink-100');
                themeToggleBtn.classList.replace('text-yellow-300', 'text-pink-500');
                themeToggleBtn.classList.replace('hover:bg-gray-600', 'hover:bg-pink-200');
            }
        }

        // --- Avatar Logic ---
        function setFace(mood) {
            // Simple Sad Filter Only - No Movement
            if(avatarImg) {
                if(mood === 'sad' || mood === 'worry') {
                    avatarImg.classList.add('anim-sad');
                } else {
                    avatarImg.classList.remove('anim-sad');
                }
            }
        }

        function addMessage(text, isUser) {
            const rowDiv = document.createElement('div');
            rowDiv.className = `chat-row ${isUser ? 'user' : 'bot'}`;
            
            if (!isUser) {
                const avatar = document.createElement('img');
                const mainAvatar = document.getElementById('avatar-img');
                // Use the main avatar image as source for small chat bubbles
                avatar.src = mainAvatar && mainAvatar.src ? mainAvatar.src : 'https://api.dicebear.com/9.x/avataaars/svg?seed=PiNanaFallback';
                avatar.className = "chat-avatar-small";
                avatar.onerror = function() { this.src = 'https://api.dicebear.com/9.x/avataaars/svg?seed=PiNanaFallback'; };
                rowDiv.appendChild(avatar);
            }

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `chat-bubble ${isUser ? 'user-bubble' : 'bot-bubble'}`;
            
            // Parse Markdown for AI responses
            if (!isUser && window.marked) {
                bubbleDiv.innerHTML = marked.parse(text);
            } else {
                bubbleDiv.innerText = text;
            }
            
            rowDiv.appendChild(bubbleDiv);
            chatContainer.appendChild(rowDiv);
            setTimeout(() => { chatContainer.scrollTop = chatContainer.scrollHeight; }, 50);
        }

        window.quickSend = function(text) {
            userInput.value = text;
            handleSend();
            if (window.innerWidth > 640) userInput.focus();
        };

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text) return;

            addMessage(text, true);
            userInput.value = '';

            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.7';
            typingIndicator.style.display = 'flex';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (gameState.active) {
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    processGameInput(text);
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                }, 1000);
            } else {
                if (text.includes("‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°") || text.includes("‡∏à‡∏µ‡∏ö")) {
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        startGame();
                        sendBtn.disabled = false;
                        sendBtn.style.opacity = '1';
                    }, 1000);
                } else {
                    let aiResponse = null;
                    if (window.callGeminiSDK) {
                        aiResponse = await window.callGeminiSDK(text);
                    }

                    typingIndicator.style.display = 'none';
                    
                    if (aiResponse) {
                        addMessage(aiResponse, false);
                        if(window.setFace) {
                            if(aiResponse.includes("‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à") || aiResponse.includes("‡πÄ‡∏®‡∏£‡πâ‡∏≤")) window.setFace('sad');
                            else window.setFace('happy');
                        }
                    } else {
                        const fallbackResponse = getScriptedResponse(text);
                        addMessage(fallbackResponse.text, false);
                        if(window.setFace) window.setFace(fallbackResponse.mood);
                    }
                    
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                }
            }
        }

        // --- Offline Scripted Logic (Backup) ---
        function getScriptedResponse(input) {
            const text = input.toLowerCase();
            const gentleResponses = {
                "tired": { text: "‡πÇ‡∏≠‡πã‡πÜ... ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏Å‡∏≠‡∏î‡∏ô‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? ‡∏û‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏à‡πä‡∏∞", mood: "worry" },
                "love": { text: "‡∏á‡∏∑‡πâ‡∏≠‡∏≠‡∏≠... ‡∏õ‡∏≤‡∏Å‡∏´‡∏ß‡∏≤‡∏ô‡∏à‡∏±‡∏á‡πÄ‡∏•‡∏¢ ‡∏ä‡∏∑‡πà‡∏ô‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢‡∏à‡πâ‡∏∞!", mood: "love" },
                "default": { text: "‡∏à‡πâ‡∏∞... ‡∏û‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ü‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞ (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î Offline ‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ô‡∏∞‡∏à‡πä‡∏∞)", mood: "happy" }
            };
            
            if (text.includes("‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢")) return gentleResponses.tired;
            if (text.includes("‡∏£‡∏±‡∏Å") || text.includes("‡∏™‡∏ß‡∏¢")) return gentleResponses.love;
            return gentleResponses.default;
        }

        // --- Endless Game Logic ---
        const gameScenarios = [
            { q: "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏û‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏û‡∏≤‡∏û‡∏µ‡πà‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏î‡∏µ?", check: t => t.includes('‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà') || t.includes('‡∏ó‡∏∞‡πÄ‡∏•') ? 10 : (t.includes('‡∏´‡πâ‡∏≤‡∏á') ? 5 : 0), replies: { good: "‡∏ß‡πâ‡∏≤‡∏ß! ‡∏£‡∏π‡πâ‡πÉ‡∏à‡∏û‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢ ü•∞", ok: "‡∏Å‡πá‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ô‡∏∞‡∏à‡πä‡∏∞", bad: "‡∏´‡∏∑‡∏°? ‡πÅ‡∏õ‡∏•‡∏Å‡∏î‡∏µ‡∏ô‡∏∞" } },
            { q: "‡∏ñ‡πâ‡∏≤‡∏û‡∏µ‡πà‡∏ó‡∏≥‡∏Ç‡∏ô‡∏°‡πÑ‡∏´‡∏°‡πâ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏á?", check: t => t.includes('‡∏≠‡∏£‡πà‡∏≠‡∏¢') || t.includes('‡∏Å‡∏¥‡∏ô') ? 10 : (t.includes('‡πÑ‡∏´‡∏°‡πâ') ? 5 : -5), replies: { good: "‡πÇ‡∏ò‡πà‡∏Ñ‡∏ô‡∏î‡∏µ... ‡∏Å‡∏¥‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢‡πÄ‡∏´‡∏£‡∏≠? ‡∏£‡∏±‡∏Å‡∏ô‡∏∞ üíñ", ok: "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ö‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡πÜ ‡∏à‡πâ‡∏∞", bad: "‡πÅ‡∏á... ‡πÉ‡∏à‡∏£‡πâ‡∏≤‡∏¢‡∏à‡∏±‡∏á üò¢" } },
            { q: "‡∏°‡∏µ‡∏´‡∏ô‡∏∏‡πà‡∏°‡πÜ ‡∏°‡∏≠‡∏á‡∏û‡∏µ‡πà ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏ó‡∏≥‡πÑ‡∏á?", check: t => t.includes('‡∏´‡∏ß‡∏á') || t.includes('‡∏à‡∏±‡∏ö‡∏°‡∏∑‡∏≠') ? 10 : (t.includes('‡∏°‡∏≠‡∏á') ? 5 : -5), replies: { good: "‡∏´‡∏ß‡∏á‡∏û‡∏µ‡πà‡πÄ‡∏´‡∏£‡∏≠? ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏à‡∏±‡∏á... (‡πÄ‡∏Ç‡∏¥‡∏ô)", ok: "‡πÅ‡∏´‡∏° ‡∏Å‡πá‡∏û‡∏µ‡πà‡∏™‡∏ß‡∏¢‡∏ô‡∏µ‡πà‡∏ô‡∏≤", bad: "‡πÑ‡∏°‡πà‡∏´‡∏ß‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏´‡∏£‡∏≠? ‡πÄ‡∏ä‡∏≠‡∏∞!" } }
        ];

        function startGame() {
            if (gameState.active) return;
            gameState.active = true;
            addMessage("üå∏ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏µ‡∏ö‡∏û‡∏µ‡πà‡∏ô‡∏≤‡∏ô‡πâ‡∏≤! ‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏ô‡πÉ‡∏à‡∏ô‡∏∞‡∏à‡πä‡∏∞... ‡πÄ‡∏£‡∏¥‡πà‡∏°!", false);
            setTimeout(askRandomQuestion, 1500);
        }

        function quitGame() {
            gameState.active = false;
            gameStatusBar.style.display = 'none';
            addMessage(`‡∏à‡∏ö‡πÄ‡∏Å‡∏°‡∏à‡πâ‡∏∞! ‡∏™‡∏ô‡∏∏‡∏Å‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢ ‡πÑ‡∏ß‡πâ‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞ (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${gameState.score})`, false);
            localStorage.setItem('nana_score', gameState.score);
            if(window.setFace) window.setFace('happy');
        }

        function processGameInput(text) {
            if (["‡πÄ‡∏•‡∏¥‡∏Å", "‡∏û‡∏≠", "‡∏´‡∏¢‡∏∏‡∏î"].some(w => text.includes(w))) { quitGame(); return; }
            
            const scenario = gameScenarios[Math.floor(Math.random() * gameScenarios.length)];
            const score = scenario.check(text);
            gameState.score += score;
            
            let reply = score >= 10 ? scenario.replies.good : (score > 0 ? scenario.replies.ok : scenario.replies.bad);
            let mood = score >= 10 ? 'love' : (score > 0 ? 'happy' : 'angry');
            
            addMessage(reply, false);
            if(window.setFace) window.setFace(mood);
            updateHeartBar();
            setTimeout(askRandomQuestion, 2000);
        }

        function askRandomQuestion() {
            if(!gameState.active) return;
            const q = gameScenarios[Math.floor(Math.random() * gameScenarios.length)].q;
            gameStatusBar.style.display = 'flex';
            addMessage(q, false);
            if(window.setFace) window.setFace('happy');
        }

        function updateHeartBar() {
            let percent = Math.min(100, Math.max(0, gameState.score));
            miniHeartBar.style.width = `${percent}%`;
            scoreDisplay.innerText = gameState.score;
        }

        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSend(); });
    </script>
</body>
</html>
